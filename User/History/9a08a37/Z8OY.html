<?php

	$completo=false;
	$faltacampo=false;

   
	if(isset($_POST["accion"])){
		$id=$_POST["accion"];
		$completo=true;

		$guardado=$_POST["guardado"];

		$nombre=quitaComillasD($_POST["nombre"]);
		$apellidos=quitaComillasD($_POST["apellidos"]);
		$email=quitaComillasD($_POST["email"]);
		$telefono=quitaComillasD($_POST["telefono"]);
		//$movil=quitaComillasD($_POST["movil"]);
		$direccion=quitaComillasD($_POST["direccion"]);
		$provincia=quitaComillasD($_POST["provincia"]);
		$localidad=quitaComillasD($_POST["localidad"]);
		$cp=quitaComillasD($_POST["cp"]);
		$contrasena=quitaComillasD($_POST["contrasena"]);
		$cif=quitaComillasD($_POST["cif"]);
		$observaciones=quitaComillasD($_POST["observaciones"]);
		$nombreImg=/*quitaComillasD($_POST["nombreImg"])*/"";
		$tipoentidad=intval(quitaComillasD($_POST["tipoentidad"]));
		$nombrecomercial=quitaComillasD($_POST["nombrecomercial"]);
		
		//comprobar pass valida
		/*
		$contrasenaInvalida="n";

		*/
		
   		//para la validación de campos obligatorios
		/*
		$emailDuplicado=comprobarEmailUsado($email,"usuarios",$id,$con);//email duplicado
		if($nombre=="" || $email=="" || $emailDuplicado=="s" || $contrasenaInvalida=="s"){
			$completo=false;
			$faltacampo=true;
		}*/
   
		//segun que perfil updatear estos campos
		$datosUpdate="";
		if($_SESSION["permisossession"]==1){
			$datosUpdate=",tipoentidad=\"".$tipoentidad."\"";
		}

		/*----------------START comprobar si es la primera vez que va a guardar para crear carpeta----------*/echo "aaaa".$guardado;
		if($guardado=="n"){
			//creardir($id,"modular/archivos_subidos/clientes");

			mkdir("./archivos_subidos/clientes/".$id,0777);//crear carpeta cliente

			if(is_dir("modular/archivos_subidos/clientes/".$id)){
			}else{
				mkdir("./archivos_subidos/clientes/".$id,0777);
				mkdir("./archivos_subidos/clientes/".$id."/doc",0777);

				//mkdir("./archivos_subidos/clientes/".$id."/safey",0777);
				//mkdir("./archivos_subidos/clientes/".$id."/contadores",0777);
				mkdir("./archivos_subidos/clientes/".$id."/audios",0777);
				//mkdir("./archivos_subidos/clientes/".$id."/parques",0777);
			}
		}
  		/*----------------END crear carpeta----------------*/

		/*----------------START subidor foto lo saco del completo para no perder la imagen----------*/
		
		/*----------------END subidor----------*/

		if($completo){
			$guardado="s";

			$patron="UPDATE usuarios SET email=\"%s\",apellidos=\"%s\", telefono=\"%s\", direccion=\"%s\", provincia=\"%s\", localidad=\"%s\", cp=\"%s\", contrasena=aes_encrypt(\"%s\",\"%s\"),nif=\"%s\",nombre=\"%s\", observaciones=\"%s\",nombrecomercial=\"%s\",fotoperfil=\"%s\",guardado=\"s\"%s WHERE id=\"%s\"";
			$sql=sprintf($patron, $email,$apellidos, $telefono, $direccion, $provincia, $localidad, $cp, $contrasena, BBDDK, $cif,$nombre,$observaciones,$nombrecomercial,$nombreImg,$datosUpdate,$id);
			$respuesta=mysqli_query($con,$sql) or die ("Error al buscar 11");
		}

		$titulof="EDICIÓN DE USUARIO / EMPRESA";
	}else{
      	if(isset($_GET["i"])){
			$patron="SELECT nombre,apellidos,nif,telefono,movil,email,direccion,provincia,localidad,cp,observaciones,aes_decrypt(contrasena, \"%s\"),guardado,tipoentidad,nombrecomercial FROM usuarios WHERE id=\"%s\"";
			$sql=sprintf($patron,BBDDK,$_GET["i"]);
			$respuesta=mysqli_query($con,$sql) or die ("Error al buscar 12");
			$fila=mysqli_fetch_array($respuesta);

			$nombre=$fila[0];
			$apellidos=$fila[1];
			$cif=$fila[2];
			$telefono=$fila[3];
			$movil=$fila[4];
			$email=$fila[5];
			$direccion=$fila[6];
			$provincia=$fila[7];
			$localidad=$fila[8];
			$cp=$fila[9];
			$observaciones=$fila[10];
			$contrasena=$fila[11];
			$guardado=$fila[12];
			$tipoentidad=$fila[13];
			$nombrecomercial=$fila[14];

			$id=$_GET["i"];

			$titulof="EDICIÓN DE USUARIO / EMPRESA";
          }else{

			$nombre="";
			$apellidos="";
			$email="";
			$telefono="";
			$movil="";
			$direccion="";
			$provincia=0;
			$localidad="";
			$cp="";
			$contrasena="";
			$cif="";
			$observaciones="";
			$nombreImg="";
			$tipoentidad="";
			$nombrecomercial="";
			$guardado="n";
		
			$patron="INSERT INTO usuarios SET borrado=\"n\",guardado=\"n\",idempresa=\"0\",nombre=\"\",telefono=\"\",email=\"\",contrasena=aes_encrypt(\"%s\",\"%s\"),permisos=\"2\",apellidos=\"\",nif=\"\",movil=\"\",localidad=\"\",cp=\"\",provincia=\"0\",direccion=\"\",fotoperfil=\"\",observaciones=\"\",tipoentidad=\"0\",accesos=\"0\",ultimaconexion=\"2020-01-01\",numrecuperacionespass=\"0\",frecuperacionespasss=\"2020-01-01\",fechaalta=\"%s\"";
			$sql=sprintf($patron,$contrasena,BBDDK,date("Y-m-d"));
			$respuesta=mysqli_query($con,$sql) or die ("Error al buscar 13");
			$id=mysqli_insert_id($con);

			$patron3="DELETE FROM usuarios WHERE fechaalta<\"%s\" AND guardado=\"n\"";
			$sql3=sprintf($patron3,date("Y-m-d"));
			$respuesta3=mysqli_query($con,$sql3) or die ("Error al borrar 14");

			$titulof="NUEVO USUARIO / EMRPESA";
          }
      }
   
	if($completo){
		if($_SESSION["permisossession"]==2){
			printf("<script>cargaLocation('index.php?s=2&i=%s');</script>",$id);
		}else{
			printf("<script>cargaLocation('index.php?s=1');</script>");
		}
	}
?>
<!--begin::Content-->
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
	<!--begin::Subheader-->
	<div class="subheader py-2 py-lg-6 subheader-solid" id="kt_subheader">
		<div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
			<!--begin::Info-->
			<div class="d-flex align-items-center flex-wrap mr-1">
				<!--begin::Page Heading-->
				<div class="d-flex align-items-baseline flex-wrap mr-5">
					<!--begin::Page Title-->
					<h5 class="text-dark font-weight-bold my-1 mr-5">DIP BADAJOZ | Usuarios</h5>
					<!--end::Page Title-->
					<!--begin::Breadcrumb-->
					<ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 font-size-sm">
						<li class="breadcrumb-item">
							<a href="index.php" class="text-muted">Inicio</a>
						</li>
						<li class="breadcrumb-item">
							<a href="index.php?s=1" class="text-muted">Usuarios</a>
						</li>
						<li class="breadcrumb-item">
							<a href="" class="text-muted"><?php echo $nombre;?></a>
						</li>
					</ul>
					<!--end::Breadcrumb-->
				</div>
				<!--end::Page Heading-->
			</div>
			<!--end::Info-->
			<!--begin::Toolbar-->
			<div class="d-flex align-items-center">
				<button class="btn btn-success mr-2" onClick="ejecutaForm('formulario');">Guardar Cambios</button>
				<?php if($_SESSION["permisossession"]==1 && $guardado=="s"){?>
				<button class="btn btn-danger" onclick="confirmacion('warning','Eliminar Usuario','¿Estas seguro de que deseas eliminar este usuario?',1,'<?php echo $id;?>','','');">Eliminar</button>
				<?php }?>
			</div>
			<!--end::Toolbar-->
		</div>
	</div>
	<!--end::Subheader-->
	<!--begin::Entry-->
	<div class="d-flex flex-column-fluid">
		<!--begin::Container-->
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					
					 <form class="form" autocomplete="off" method="post" action="index.php?s=2<?php if($id>0){ echo "&i=".$id; } ?>" id="formulario" enctype="multipart/form-data">
						<!--begin::Card-->
                         
                         <div class="card card-custom mt-2 gutter-b" data-card="true">
                            <div class="card-header">
                                <div class="card-title">
                                    <h3 class="card-label">Información Personal</h3>
                                </div>
                                <div class="card-toolbar">
                                    <!--<button class="btn btn-success mr-2" onClick="ejecutaForm('formulario');">Guardar Cambios</button>
										<?php if($_SESSION["permisossession"]==1 && $guardado=="s"){?>
										<button class="btn btn-danger" onclick="confirmacion('warning','Eliminar Nodo','¿Estas seguro de que deseas eliminar este nodo?',2,'<?php echo $id;?>','','');">Eliminar</button>
										<?php }?>-->
                                    <a href="#" class="btn btn-icon btn-sm btn-light-primary mr-1" data-card-tool="toggle">
                                        <i class="ki ki-arrow-down icon-nm"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body">
								 <div class="form-group row">
                                    <div class="col-lg-6">
                                        <label>Tipo Usuario:</label>
                                        <select class="form-control" name="tipoentidad">
											<option value="0" <?php if($tipoentidad==0){echo "selected";}?>>...</option>
											<option value="1" <?php if($tipoentidad==1){echo "selected";}?>>Particular</option>
											<option value="2" <?php if($tipoentidad==2){echo "selected";}?>>Empresa</option> 
											<option value="3" <?php if($tipoentidad==3){echo "selected";}?>>Autónomo</option> 
											<option value="4" <?php if($tipoentidad==4){echo "selected";}?>>Organismo Público</option> 
											<option value="5" <?php if($tipoentidad==5){echo "selected";}?>>Asociación</option> 
										</select>
                                    </div>
									<div class="col-lg-6">
                                       
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-6">
                                        <label>Nombre:<span class="text-danger">*</span></label>
                                        <input type="text" class="form-control <?php if($faltacampo && $nombre==""){echo "is-invalid";}?>" name="nombre" value="<?php echo $nombre;?>" placeholder="Nombre" maxlength="65"/>
                                        <span class="form-text text-muted">Por favor introduce el nombre del cliente.</span>
                                    </div>
                                    <div class="col-lg-6">
                                        <label>Apellidos:</label>
                                        <input type="text" class="form-control " name="apellidos" value="<?php echo $apellidos;?>" placeholder="Apellidos" maxlength="65"/>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-6">
                                        <label>Nombre Empresa:</label>
                                        <input type="text" class="form-control <?php if($faltacampo && $email==""){echo "is-invalid";}?>" name="nombrecomercial" value="<?php echo $nombrecomercial;?>" placeholder="Nombre Comercial" maxlength="65"/>
                                    </div>
                                    <div class="col-lg-6">
                                        <label>Dirección:</label>
                                        <input type="text" class="form-control" name="direccion" value="<?php echo $direccion;?>" placeholder="Dirección" maxlength="65"/>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-6">
                                        <label>Localidad:</label>
                                        <input type="text" class="form-control" name="localidad" value="<?php echo $localidad;?>" placeholder="Localidad" maxlength="65"/>
                                    </div>
                                    <div class="col-lg-6">
                                        <label>Provincia:</label>
                                        <?php echo cargaProvinciasGenerico($provincia,"provincia",$con);?>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-6">
                                        <label>Cod. Postal:</label>
                                        <input type="text" class="form-control" name="cp" value="<?php echo $cp;?>" placeholder="Cód. Postal" maxlength="10"/>
                                    </div>
                                    <div class="col-lg-6">
                                        <label>CIF/NIF:</label>
                                        <input type="text" class="form-control" name="cif" value="<?php echo $cif;?>" placeholder="CIF/NIF" maxlength="12"/>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-6">
                                        <label>Teléfono:</label>
                                        <input type="text" class="form-control" name="telefono" value="<?php echo $telefono;?>" placeholder="Teléfono" maxlength="20"/>
                                    </div>
                                    <div class="col-lg-6">
                                        
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-6">
                                        <label>Email Administrador:<span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="email" value="<?php echo $email;?>" placeholder="Email" maxlength="40"/>
                                    </div>
                                    <div class="col-lg-6">
                                        <label>Cotraseña Administrador:</label>
										<div class="input-group">
											<input type="password" class="form-control <?php if($faltacampo && $nombre==""){echo "is-invalid";}?>" name="contrasena" id="contrasena" value="<?php echo $contrasena;?>" placeholder="Cotraseña" maxlength="50"/>
											<div class="input-group-append">
												<div class="btn btn-secondary" id="btncontrasena" onClick="mostrarOcultarPass('contrasena');"><i class="flaticon-eye"></i></div>
											</div>
										</div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-lg-12">
                                        <label>Observaciones:</label>
                                        <input type="text" class="form-control" name="observaciones" value="<?php echo $observaciones;?>" placeholder="Observaciones" maxlength="140"/>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="row">
                                    <!--<div class="col-lg-6">
                                        <button type="reset" class="btn btn-primary mr-2">Save</button>
                                        <button type="reset" class="btn btn-secondary">Cancel</button>
                                    </div>
                                    <div class="col-lg-6 text-lg-right">
                                        <button type="reset" class="btn btn-danger">Delete</button>
                                    </div>-->
                                </div>
                            </div>
                        </div>
						<!--end::Card-->
	
						<!--begin::Card-->
						<div class="card card-custom gutter-b example example-compact card-collapse" data-card="true">
							<div class="card-header">
								<h3 class="card-title">Configurar Accesos Usuarios</h3>
								<div class="card-toolbar">
									<div class="example-tools justify-content-center">
										
									</div>
								</div>
							</div>
							<div class="card-body">
								<!--begin::Search Form-->
								<div class="mb-7">
									<div class="row align-items-center">
										<div class="col-lg-9 col-xl-8">
											<div class="row align-items-center">
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Nombre:</label>
														<input type="text" class="form-control" id="nombreac" maxlength="65" placeholder="Nombre"/>
													</div>
												</div>
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Teléfono:</label>
														<input type="text" class="form-control" id="telefonoac" value="" maxlength="20" placeholder="Teléfono"/>
													</div>
												</div>
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Email:</label>
														<input type="text" class="form-control" id="emailac" value="" maxlength="40" placeholder="Email"/>
													</div>
												</div>
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Contraseña:</label>
														<input type="text" class="form-control" id="contrasenaac" value="" maxlength="50" placeholder="Contraseña"/>
													</div>
												</div>
											</div>
										</div>
										<div class="col-lg-3 col-xl-4 mt-5 mt-lg-0">
											<a href="#" class="btn btn-light-primary px-6 font-weight-bold" onClick="crearUsuarioCliente(<?php echo $id;?>);return false;">Añadir</a>
										</div>
									</div>
								</div>
                                <div class="blockUI blockMsg blockElement cargadorBloque">
                                    <div class="blockui" id="cargandotablaAccesosUsuarios">
                                        <span>Cargando...</span>
                                        <span class="spinner spinner-loader spinner-primary"></span>
                                    </div>
                                </div>
								<!--begin: Datatable-->
								<table class="table table-separate table-head-custom table-checkable" style="visibility: hidden" id="tablaAccesosUsuarios" class="display" style="width:100%">
									<?php accessoUsuariosClientes($id,$con);?>
								</table>
								<!--end: Datatable-->
							</div>
						</div>
						<!--end::Card-->
						
						<input type="hidden" value="<?php echo $id; ?>" id="accion" name="accion">
                        <input type="hidden" value="<?php echo $guardado; ?>" id="guardado" name="guardado">
                	</form>
					
				</div>
			</div>
		</div>
		<!--end::Container-->
	</div>
	<!--end::Entry-->
</div>
<!--end::Content-->

<script>
    jQuery(document).ready(function() {
		//tabla
        var columnasTabUsuarios= [null,{ "width": "20%" },{ "width": "15%" },{ "width": "30%" },{ "width": "30%" },{ "width": "5%" }];
        cargarTabla.init("tablaAccesosUsuarios",columnasTabUsuarios,[1, "asc"],50,true);
    });
</script>