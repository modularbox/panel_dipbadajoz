<?php

	$completo=false;
	$faltacampo=false;
	
	if(isset($_POST["accion"])){
		$id=$_POST["accion"];
		$completo=true;

		$guardado=$_POST["guardado"];
		$nombre=quitaComillasD($_POST["nombre"]);
		$descripcion=quitaComillasD($_POST["descripcion"]);
		$idusuario=quitaComillasD($_POST["idusuario"]);

		$datosUpdate="";
		if($_SESSION["permisossession"]==1){
			$datosUpdate=",idusuario=\"".$idusuario."\"";
		}else if($_SESSION["permisossession"]!=1){
			$datosUpdate=",idusuario=\"".calculaIdEmpresa($con)."\"";
		}

   		//para la validación de campos obligatorios
		if($nombre==""){
			$completo=false;
			$faltacampo=true;
		}

		if($completo){
			$guardado="s";

			$patron="UPDATE luces_horarios SET nombre=\"%s\",descripcion=\"%s\",guardado=\"s\"%s WHERE id=\"%s\"";
			$sql=sprintf($patron,$nombre,$descripcion,$datosUpdate,$id);
			$respuesta=mysqli_query($con,$sql) or die ("Error al buscar 1124562225786345877990");
		}

		$titulof="EDICIÓN DE HORARIO";
	}else{
      	if(isset($_GET["i"])){
			$patron="SELECT nombre,guardado,idusuario,descripcion FROM luces_horarios WHERE id=\"%s\"";
			$sql=sprintf($patron,$_GET["i"]);
			$respuesta=mysqli_query($con,$sql) or die ("Error al buscar 12334567765544");
			$fila=mysqli_fetch_array($respuesta);

			$nombre=$fila[0];
			$guardado=$fila[1];
			$idusuario=$fila[2];
			$descripcion=$fila[3];
			
			$id=$_GET["i"];

			$titulof="EDICIÓN DE HORARIO";
          }else{

			$nombre="";
			$idusuario=0;
			$descripcion="";
			$guardado="n";
			
			$patron="INSERT INTO luces_horarios SET nombre=\"\",idusuario=\"%s\",descripcion=\"%s\",guardado=\"n\",fechaalta=\"%s\"";
			$sql=sprintf($patron,$idusuario,$descripcion,date("Y-m-d"));
			$respuesta=mysqli_query($con,$sql) or die ("Error al buscar 133466786754454763");
			$id=mysqli_insert_id($con);

			$patron3="DELETE FROM luces_horarios WHERE fechaalta<\"%s\" AND guardado=\"n\"";
			$sql3=sprintf($patron3,date("Y-m-d"));
			$respuesta3=mysqli_query($con,$sql3) or die ("Error al borrar 14334543456663");

			$titulof="NUEVO HORARIO";
          }
      }
   
	if($completo){
		//printf("<script>cargaLocation('index.php?s=13');</script>");
		printf("<script>cargaLocation('index.php?s=14&i=%s');</script>",$id);
	}
?>
<!--begin::Content-->
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
	<!--begin::Subheader-->
	<div class="subheader py-2 py-lg-6 subheader-solid" id="kt_subheader">
		<div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
			<!--begin::Info-->
			<div class="d-flex align-items-center flex-wrap mr-1">
				<!--begin::Page Heading-->
				<div class="d-flex align-items-baseline flex-wrap mr-5">
					<!--begin::Page Title-->
					<h5 class="text-dark font-weight-bold my-1 mr-5">DIP BADAJOZ | Horarios Luces</h5>
					<!--end::Page Title-->
					<!--begin::Breadcrumb-->
					<ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 font-size-sm">
						<li class="breadcrumb-item">
							<a href="index.php" class="text-muted">Inicio</a>
						</li>
						<li class="breadcrumb-item">
							<a href="index.php?s=13" class="text-muted">Horarios Luces</a>
						</li>
						<li class="breadcrumb-item">
							<a href="" class="text-muted"><?php echo $nombre;?></a>
						</li>
					</ul>
					<!--end::Breadcrumb-->
				</div>
				<!--end::Page Heading-->
			</div>
			<!--end::Info-->
			<!--begin::Toolbar-->
			<div class="d-flex align-items-center">
				<button class="btn btn-success mr-2" onClick="ejecutaForm('formulario');">Guardar Cambios</button>
				<?php if($_SESSION["permisossession"]==1 && $guardado=="s"){?>
				<button class="btn btn-danger" onclick="confirmacion('warning','Eliminar Horario','¿Estas seguro de que deseas eliminar este horario?',10,'<?php echo $id;?>','','');">Eliminar</button>
				<?php }?>
			</div>
			<!--end::Toolbar-->
		</div>
	</div>
	<!--end::Subheader-->
	<!--begin::Entry-->
	<div class="d-flex flex-column-fluid">
		<!--begin::Container-->
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					
					 <form class="form" autocomplete="off" method="post" action="index.php?s=14<?php if($id>0){ echo "&i=".$id; } ?>" id="formulario" enctype="multipart/form-data">

						<!--begin::Card-->
                        <div class="card card-custom mt-2 gutter-b" data-card="true">
                            <div class="card-header">
                                <div class="card-title">
                                    <h3 class="card-label">Información del Horario</h3>
                                </div>
                                <div class="card-toolbar">
                                    <a href="#" class="btn btn-icon btn-sm btn-light-primary mr-1" data-card-tool="toggle">
                                        <i class="ki ki-arrow-down icon-nm"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="card-body">
								<div class="form-group row">
									<div class="col-lg-6">
										<label>Nombre:<span class="text-danger">*</span></label>
										<input type="text" class="form-control <?php if($faltacampo && $nombre==""){echo "is-invalid";}?>" name="nombre" value="<?php echo $nombre;?>" placeholder="nombre" />
									</div>
									<div class="col-lg-6">
										<label>Usuario/Cliente:<span class="text-danger">*</span></label>
										<?php echo cargaUsuariosGenerico($idusuario,"idusuario",$faltacampo,$con);?>
									</div>
								</div>
								<div class="form-group row">
									<div class="col-lg-12">
										<label>Observaciones:</label>
										<input type="text" class="form-control" name="descripcion" value="<?php echo $descripcion;?>" placeholder="Descripcion" />
									</div>
								</div>
							</div>
                        </div>
						<!--end::Card-->
						
						<!--begin::Card-->
						<div class="card card-custom gutter-b example example-compact" data-card="true">
							<div class="card-header">
								<h3 class="card-title">Nodos en uso</h3>
								<div class="card-toolbar">
                                    <a href="#" class="btn btn-icon btn-sm btn-light-primary mr-1" data-card-tool="toggle">
                                        <i class="ki ki-arrow-down icon-nm"></i>
                                    </a>
                                </div>
							</div>
							<div class="card-body">
								<!--begin::Search Form-->
								<div class="mb-7">
									<div class="row align-items-center">
										<div class="col-lg-9 col-xl-8">
											<div class="row align-items-center">
												<div class="col-md-12 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Nodo:</label>
														<div id="divSelectNodos"><?php echo cargaNodosHorarioLucesSelect($idusuario,$id,"nodoHorario",$con);?></div>
													   <div class="col-lg-3 col-xl-4 mt-5 mt-lg-0">
											                <a href="#" class="btn btn-light-primary px-6 font-weight-bold" onClick="anadirNodoLucesHorario(<?php echo $id;?>);return false;">Añadir</a>
										              </div>
                                                    </div>
												</div>
											</div>
										</div>

									</div>
								</div>
                                <div class="blockUI blockMsg blockElement cargadorBloque">
                                    <div class="blockui" id="cargandotablaNodosHorario">
                                        <span>Cargando...</span>
                                        <span class="spinner spinner-loader spinner-primary"></span>
                                    </div>
                                </div>
								<!--begin: Datatable-->
								<table class="table table-separate table-head-custom table-checkable" style="visibility: hidden" id="tablaNodosHorario">
									<?php cargaNodosHorariosLuces($id,$con);?>
								</table>
								<!--end: Datatable-->
							</div>
						</div>
						<!--end::Card-->
						 
						<!--begin::Card-->
						<div class="card card-custom gutter-b example example-compact" data-card="true">
							<div class="card-header">
								<h3 class="card-title">Configurar programas / horarios</h3>
								<div class="card-toolbar">
                                    <a href="#" class="btn btn-icon btn-sm btn-light-primary mr-1" data-card-tool="toggle">
                                        <i class="ki ki-arrow-down icon-nm"></i>
                                    </a>
                                </div>
							</div>
							<div class="card-body">
								<!--begin::Search Form-->
								<div class="mb-7">
									<div class="row align-items-center">
										<div class="col-lg-9 col-xl-8">
											<div class="row align-items-center">
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Programa:</label>
														<?php echo cargaProgramasLuces($idusuario,$id,"programaConfHorario",$con);?>
													</div>
												</div>
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Día:</label>
														<?php echo cargaDiasSemana(0,"diaConfHorario",$con);?>
													</div>
												</div>
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Desde:</label>
														<input type="time" class="form-control" id="horadConfHorario" value="<?php echo date("H:i");?>"/>
													</div>
												</div>
												<div class="col-md-3 my-2 my-md-0">
													<div class="d-flex align-items-center">
														<label class="mr-3 mb-0 d-none d-md-block">Hasta:</label>
														<input type="time" class="form-control" id="horahConfHorario" value="<?php echo date("H:i");?>"/>
													</div>
												</div>
											</div>
										</div>
										<div class="col-lg-3 col-xl-4 mt-5 mt-lg-0">
											<a href="#" class="btn btn-light-primary px-6 font-weight-bold" onClick="anadirProgramaHorario('<?php echo $id;?>');return false;">Añadir</a>
										</div>
									</div>
								</div>
								<!--end::Search Form-->
                                <div class="blockUI blockMsg blockElement cargadorBloque">
                                    <div class="blockui" id="cargandotablaHorarioHoras">
                                        <span>Cargando...</span>
                                        <span class="spinner spinner-loader spinner-primary"></span>
                                    </div>
                                </div>
								<!--begin: Datatable-->
								<table class="table table-separate table-head-custom table-checkable" style="visibility: hidden" id="tablaHorarioHoras">
									<?php horariosLucesConf($id,$con);?>
								</table>
								<!--end: Datatable-->
                            </div>
                        </div>
						<!--end::Card-->
						
						<input type="hidden" value="<?php echo $id; ?>" id="accion" name="accion">
                        <input type="hidden" value="<?php echo $guardado; ?>" id="guardado" name="guardado">
                	</form>
					
				</div>
			</div>
		</div>
		<!--end::Container-->
	</div>
	<!--end::Entry-->
</div>
<!--end::Content-->

<script>
    jQuery(document).ready(function() {
		//tabla
        var columnasTab= [null,{ "width": "80%" },{ "width": "20%" }];
        cargarTabla.init("tablaNodosHorario",columnasTab,[1, "asc"],50);
		
		//tabla
        var columnasHorarioHoras= [null,{ "width": "30%" },{ "width": "30%" },{ "width": "15%" },{ "width": "15%" },{ "width": "10%" }];
        cargarTabla.init("tablaHorarioHoras",columnasHorarioHoras,[0, "asc"],50,true);
    });
</script>